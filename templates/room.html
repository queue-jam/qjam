<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Stream Aggregator</title>
    <link rel="icon" href="/static/M.ico" type="image/x-icon" />

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="http://SortableJS.github.io/Sortable/Sortable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- CSS Reset & Variables --- */
      :root {
        --bg-color: #050505;
        --text-primary: #ffffff;
        --text-secondary: #aaaaaa;
        --player-height: 90px;
        --header-height: 80px;
        --glass-bg: rgba(20, 20, 20, 0.6);
        --glass-border: rgba(255, 255, 255, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Desktop default */
        position: relative;
      }

      /* --- AMBIENT BACKGROUND --- */
      #ambient-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }
      #ambient-background img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(80px) brightness(0.4) saturate(1.5);
        transform: scale(1.2);
        transition: opacity 1s ease;
      }
      .vignette {
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.8) 100%
        );
      }

      /* --- HEADER --- */
      header {
        /* Desktop: Fixed height, Flex row */
        height: var(--header-height);
        padding: 0 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 100;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
        gap: 20px;
      }

      .header-controls-left,
      .header-controls-right {
        display: flex;
        align-items: center;
        z-index: 2;
      }

      /* --- SEARCH (New Layout) --- */
      .search-container {
        display: flex;
        gap: 10px;
        width: 100%;
        max-width: 500px;
        position: absolute; /* Absolute centering for desktop */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1;
      }

      .input-wrapper {
        position: relative;
        flex-grow: 1;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px 20px;
        border-radius: 99px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 1rem;
        outline: none;
        transition: all 0.2s;
        -webkit-appearance: none;
      }
      input[type="text"]:focus {
        background: rgba(0, 0, 0, 0.8);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .btn-add {
        background: white;
        color: black;
        border: none;
        height: 100%;
        padding: 0 24px;
        border-radius: 99px;
        font-weight: 700;
        cursor: pointer;
        flex-shrink: 0;
      }

      #search-results {
        position: absolute;
        top: 115%;
        left: 0;
        right: 0;
        background: #1a1a1a;
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 60vh;
        overflow-y: auto;
        z-index: 1000;
        border: 1px solid #333;
      }
      #search-results li {
        padding: 14px 20px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        font-size: 0.95rem;
      }
      #search-results li:hover {
        background: #333;
      }

      /* --- MAIN LAYOUT (New Mobile/Desktop Hybrid) --- */
      main {
        flex: 1;
        display: flex;
        height: calc(100vh - var(--header-height) - var(--player-height));
        overflow: hidden;
        padding: 40px;
        gap: 60px;
        max-width: 1600px;
        width: 100%;
        margin: 0 auto;
      }

      .art-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 300px;
      }

      #now-playing-art {
        width: 100%;
        max-width: 450px;
        aspect-ratio: 1/1;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        margin-bottom: 30px;
      }
      #now-playing-art img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #main-info-area {
        text-align: center;
      }
      #main-title {
        font-size: 2.2rem;
        font-weight: 800;
        margin: 0 0 8px 0;
        line-height: 1.1;
      }
      #main-artist {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
      }

      .queue-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 24px;
        border: 1px solid var(--glass-border);
        min-width: 320px;
      }

      .queue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .queue-header h3 {
        margin: 0;
        font-size: 0.9rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      #queue-scroll-area {
        overflow-y: auto;
        flex: 1;
        padding-right: 5px;
      }

      /* --- PLAYER BAR --- */
      .player-bar {
        height: var(--player-height);
        background: rgba(10, 10, 10, 0.9);
        backdrop-filter: blur(25px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 20px;
        z-index: 200;
        flex-shrink: 0;
      }

      .btn-delete {
        background: none;
        border: none;
        color: #666;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
      }
      .btn-delete:hover {
        background: rgba(255, 60, 60, 0.2);
        color: #ff5555;
      }
      
      .btn-play-top {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-play-top:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* =========================================
         RESTORED STYLES (Dialogs & Menus)
         ========================================= */
      
      /* 1. Trigger Buttons (Restored from Original) */
      #open-permissions-btn, #open-dialog-btn {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        cursor: pointer;
        backdrop-filter: blur(12px);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 8px 20px rgba(0, 0, 0, 0.35);
        transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        white-space: nowrap;
      }
      
      #open-permissions-btn:hover, #open-dialog-btn:hover {
        background: rgba(255, 255, 255, 0.14);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      
      #open-permissions-btn:active, #open-dialog-btn:active {
        transform: scale(0.96);
      }

      /* 2. Dialog General Styles (Restored) */
      dialog {
        background: rgba(15, 15, 15, 0.85);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 32px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        animation: fadeIn 0.25s ease;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(6px);
      }
      dialog h2 {
        margin: 0 0 12px 0;
        font-size: 1.4rem;
        font-weight: 800;
        text-align: center;
      }
      dialog p {
        margin: 0 0 12px 0;
        color: rgba(255, 255, 255, 0.75);
        line-height: 1.5;
        word-break: break-all;
      }
      dialog button.close-btn {
        display: block;
        margin: 20px auto 0 auto;
        background: white;
        color: black;
        border: none;
        border-radius: 24px;
        padding: 10px 22px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s, filter 0.2s;
      }
      dialog button.close-btn:hover { filter: brightness(0.9); }
      dialog button.close-btn:active { transform: scale(0.96); }

      /* 3. Permissions Specific (Restored) */
      .can-queue-text, .can-order-queue-text, .can-play-text {
        color: #a8e6c1;
        text-shadow: 0 0 10px rgba(168, 230, 193, 0.2);
      }
      .cannot-play-text {
        color: #ff9b9b;
        background: rgba(255, 80, 80, 0.08);
        border-color: rgba(255, 120, 120, 0.18);
        text-shadow: 0 0 10px rgba(255, 120, 120, 0.25);
      }
      .is-host-text h2 {
        color: #9fe6b8;
        text-shadow: 0 0 18px rgba(159, 230, 184, 0.25);
      }
      .is-guest-text h2 {
        color: rgba(255, 255, 255, 0.85);
      }
      
      /* Permission Rows */
      #permissions-dialog span {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.025);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.2px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
      }

      /* 4. User Role Badges (Used in Invite Dialog) */
      .is-host-badge, .is-guest-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        margin-right: 5px;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.3px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06), 0 6px 16px rgba(0, 0, 0, 0.35);
      }
      .is-host-badge {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(255, 180, 0, 0.15));
        color: rgba(255, 230, 150, 0.95);
      }
      .is-guest-badge {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.85);
      }

      /* =========================================
         MOBILE OPTIMIZATION ( < 900px )
         ========================================= */
      @media (max-width: 900px) {
        body {
          height: 100%;
          overflow-y: auto;
          display: block;
          padding-bottom: calc(var(--player-height) + 20px);
        }

        header {
          height: auto;
          min-height: 120px;
          flex-wrap: wrap;
          padding: 15px 20px;
          background: rgba(0, 0, 0, 0.6);
          position: sticky;
          top: 0;
        }

        .header-controls-left, .header-controls-right {
          flex: 1;
          margin-bottom: 12px;
        }
        .header-controls-right {
          justify-content: flex-end;
        }

        .search-container {
          position: relative;
          left: auto;
          transform: none;
          max-width: 100%;
          order: 3;
        }

        main {
          display: flex;
          flex-direction: column;
          height: auto;
          overflow: visible;
          padding: 20px;
          gap: 25px;
        }

        .art-column {
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
          padding: 15px;
          border-radius: 16px;
          gap: 15px;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #now-playing-art {
          width: 80px;
          height: 80px;
          margin-bottom: 0;
          border-radius: 12px;
          flex-shrink: 0;
        }

        #main-info-area {
          text-align: left;
          flex: 1;
        }
        #main-title {
          font-size: 1.4rem;
          margin-bottom: 4px;
        }
        #main-artist {
          font-size: 1rem;
        }

        .queue-column {
          background: transparent;
          border: none;
          backdrop-filter: none;
          padding: 0;
          overflow: visible;
        }

        #queue-list li {
          background: rgba(20, 20, 20, 0.6);
          backdrop-filter: blur(10px);
          margin-bottom: 10px;
          border-radius: 12px;
          padding: 15px !important;
          border: 1px solid rgba(255, 255, 255, 0.05);
        }

        #queue-scroll-area {
          overflow: visible;
        }

        .player-bar {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
        }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>
    <div id="ambient-background">
      <div class="vignette"></div>
    </div>

    <header>
      <div class="header-controls-left">
        <button id="open-permissions-btn">
          Hi, {{ user.name }}!
        </button>
      </div>

      <div class="search-container">
        <div class="input-wrapper">
          <input
            type="text"
            id="url-input"
            name="query"
            placeholder="Search song..."
            autocomplete="off"
            hx-post="/search"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#search-results"
          />
          <ul id="search-results" role="listbox"></ul>
        </div>
        <form
          hx-post="/{{ room.session_id }}/queue"
          hx-target="#input-wrapper"
          style="margin: 0; display: flex;"
        >
          <input type="hidden" name="url" id="hidden-submission-url" />
          <button
            type="submit"
            class="btn-add"
            onclick="document.getElementById('hidden-submission-url').value = document.getElementById('url-input').value"
          >
            Add
          </button>
        </form>
      </div>

      <div class="header-controls-right">
        <button id="open-dialog-btn">Invite</button>
      </div>
    </header>

    <main>
      <div class="art-column">
        <div id="now-playing-art">
          <div
            style="width: 100%; height: 100%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;"
          >
            <span style="font-size: 40px; opacity: 0.2">üéµ</span>
          </div>
        </div>

        <div id="main-info-area">
          <h1 id="main-title">Ready</h1>
          <h2 id="main-artist">Add a song to start</h2>
        </div>
      </div>

      <div class="queue-column">
        <div class="queue-header">
          <h3>Up Next</h3>
          <form
            hx-post="/play"
            hx-target="#player-container"
            hx-swap="innerHTML"
            style="margin: 0"
          >
            <button type="submit" class="btn-play-top">
              ‚ñ∂ Play Top
            </button>
          </form>
        </div>

        <div id="queue-scroll-area">
          <ul id="queue-list" hx-get="/{{ room.session_id }}/queue"></ul>
        </div>
        <div id="input-wrapper"></div>
      </div>
    </main>

    <div class="player-bar">
      <div id="player-container">
        <div style="color: #888; font-size: 0.9rem">No music playing</div>
      </div>
    </div>

    <dialog id="permissions-dialog">
        {% if user.host %}
        <span class="is-host-text"><h2>You are the host of the room!</h2></span>
        {% else %}
        <span class="is-guest-text"><h2>You are a guest of the room!</h2></span>
        {% endif %}
        
        <span class="can-queue-text">‚úÖ You can queue songs</span>
        <span class="can-order-queue-text">‚úÖ You can change the queue order</span>
        
        {% if user.host %}
        <span class="can-play-text">‚úÖ You can play songs</span>
        {% else %}
        <span class="cannot-play-text">‚ùå You cannot play songs</span>
        {% endif %}
        
        <button id="close-permissions-btn" class="close-btn">Close</button>
    </dialog>

    <dialog id="invite-dialog">
        <h2>Invite friends!</h2>
        <p><b>Code:</b> <span style="font-family: monospace; font-size: 1.1em;">{{ room.session_id }}</span></p>

        <div id="qrcode-wrapper" style="display: flex; justify-content: center; margin: 20px 0;">
            <div id="qrcode" style="padding: 15px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"></div>
        </div>
        
        <div id="user-list-container">
            {% for user in room.users %} 
                {% if user.host %}
                <span class="is-host-badge">{{ user.name }} (host)</span>
                {% else %}
                <span class="is-guest-badge">{{ user.name }} (guest)</span>
                {% endif %} 
            {% endfor %}
        </div>

        <br />
        <button id="close-dialog-btn" class="close-btn">Close</button>
    </dialog>

    <script>
      // Dialog Logic
      const permDialog = document.getElementById("permissions-dialog");
      const inviteDialog = document.getElementById("invite-dialog");

      document.getElementById("open-permissions-btn").onclick = () => permDialog.showModal();
      document.getElementById("close-permissions-btn").onclick = () => permDialog.close();

      document.getElementById("open-dialog-btn").onclick = () => {
          inviteDialog.showModal();
          const qrDiv = document.getElementById("qrcode");
          if(qrDiv.innerHTML.trim() === "") {
              new QRCode(qrDiv, {
                  text: `${window.location.origin}/join?code={{ room.session_id }}`,
                  width: 160,
                  height: 160,
                  colorDark : "#000000",
                  colorLight : "#ffffff",
                  correctLevel : QRCode.CorrectLevel.H
              });
          }
      };
      document.getElementById("close-dialog-btn").onclick = () => inviteDialog.close();

      // WebSocket Logic
      const roomId = "{{ room.session_id }}";
      const currentUserId = "{{ user.id }}";
      const isHost = {{ 'true' if user.host else 'false' }};
      const queueList = document.getElementById("queue-list");
      const socket = new WebSocket(`ws://${window.location.host}/ws/${roomId}`);

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        renderQueue(data.queue);
        renderNowPlaying(data.now_playing);
        renderUsers(data.users);
      };

      async function deleteSong(songId) {
        if(!confirm("Remove song?")) return;
        try { await fetch(`/${roomId}/queue/${songId}`, { method: 'DELETE' }); }
        catch (e) { console.error(e); }
      }

      // Restored Render Users (for the Invite Dialog updates)
      function renderUsers(users) {
        const userContainer = document.getElementById("user-list-container");
        if (!userContainer || !users) return;

        userContainer.innerHTML = "";

        users.forEach((user) => {
          const span = document.createElement("span");
          if (user.host) {
            span.className = "is-host-badge"; // Using restored class
            span.textContent = `${user.name} (host)`;
          } else {
            span.className = "is-guest-badge"; // Using restored class
            span.textContent = `${user.name} (guest)`;
          }
          userContainer.appendChild(span);
        });
      }

      function renderNowPlaying(song) {
        const artDiv = document.getElementById("now-playing-art");
        const titleEl = document.getElementById("main-title");
        const artistEl = document.getElementById("main-artist");
        const bg = document.getElementById("ambient-background");

        if (!song) {
          titleEl.innerText = "Ready";
          artistEl.innerText = "Add a song to start";
          artDiv.innerHTML = `<div style="width: 100%; height: 100%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;"><span style="font-size: 30px; opacity: 0.3">üéµ</span></div>`;
          return;
        }

        titleEl.innerText = song.title;
        artistEl.innerText = song.artist;

        if (song.album_art) {
           artDiv.innerHTML = `<img src="${song.album_art}" style="width:100%; height:100%; object-fit:cover;">`;
           bg.innerHTML = `<img src="${song.album_art}"><div class="vignette"></div>`;
        }
      }

      function renderQueue(queue) {
        queueList.innerHTML = "";
        queue.forEach(item => {
          const li = document.createElement("li");
          li.dataset.id = item.id;
          li.className = "queue-item";
          li.style.cssText = "display: flex; gap: 15px; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);";

          const canDelete = isHost || (item.added_by_id === currentUserId);
          const delBtn = canDelete ? `<button class="btn-delete" onclick="deleteSong('${item.id}')">‚úï</button>` : '';

          li.innerHTML = `
            <img src="${item.album_art || 'https://placehold.co/60'}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.title}</div>
                <div style="font-size: 0.85rem; color: #aaa;">${item.artist || 'Unknown'}</div>
                <div style="font-size: 0.75rem; color: #666;">${item.added_by || 'System'}</div>
            </div>
            ${delBtn}
          `;
          queueList.appendChild(li);
        });
      }

      Sortable.create(queueList, {
          animation: 150,
          delay: 200, 
          delayOnTouchOnly: true,
          onEnd: () => {
              const order = Array.from(queueList.children).map(li => li.dataset.id);
              socket.send(JSON.stringify({ type: "reorder", order: order }));
          }
      });
    </script>
  </body>
</html>